#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Thu Jan 27 21:23:59 2022

@author: luiza.maciel
"""

import numpy as np
from scipy.integrate import odeint
from math import exp,radians
import matplotlib.pyplot as plt
AC=9.6 #mols de oxigenio 
ACm=12.99 #massica
c=6.67
hid=12.8
ox=0.533
stoichometricCO2=6.67
stoichometricH2O=6.4
stoichometricN2=3.76*AC
PCI=39249*10**3 #kJ/kg
a0=-8102.9675849653
a1=7963.204888950
a2=-2923.24238668569
a3=509.144026930886
a4=-42.2764373650608
a5=1.35175803975684
mol=((12*c+hid+16*ox)+AC*(32+3.772*28.16))/(1+AC+AC*3.772)  #massa molecular da mistura
Ae=(5.7*10**11) #octano
Ea=15098
me=0.25
ne=1.5
Var=89.25
cilindros=4
N=2493/60*2*np.pi

P0,T0=67500,371
C0=(1/((1+AC+3.773*AC)))*(P0*10**-3/(8314*T0))

Concentrations0=[C0,AC*C0,0,0,0]
print(Concentrations0)
M_c=(12.0107*c+hid*1.008+16*ox)

Ru = 8.314

m_ar=Var/(0.5*3600*cilindros*(N/(2*np.pi))) #rot por s
m_m=m_ar/ACm+m_ar #massa da mistura admitida
m_c=(m_m/(1+ACm)) 
m_c=m_ar/ACm

Y0=m_c/m_m
molsc=m_c/M_c
M_m=m_m/((1+AC+3.773*AC)*molsc)
mols=m_m/M_m

ro_fuel = P0* 10**-3 * M_c /(Ru* T0)
ro_o2 = P0* 10**-3 * 32 /(Ru * T0)
ro = P0* 10**-3 * M_m /(Ru* T0)

c0fuel=(m_c/m_m)*(ro)*10**-3/M_c
c0O2=((m_ar*0.232)/m_m)*(ro)*10**-3/32

oncentrations0 = [c0fuel,c0O2,0,0,0]
print(oncentrations0)



#fracao molar = mols de combustivel/mol de mistura -> considerar 1 mol de mistura massa

def dc (Concentrations,t,T):
    C=Concentrations[0]
    O2=Concentrations[1]
    CO=Concentrations[2]
    CO2=Concentrations[3]
    H2O=Concentrations[4]
    
    ka=Ae*exp(-Ea/T)*np.sign(C)*abs(C)**me*O2**ne
    kbf=10**14.6*exp(-20131/T)*CO*H2O**0.5*O2**0.25
    kbr=5*10**8*exp(-20131/T)*CO2
    
    dC=-ka/N
    dO2=(-(c/2+hid/4)*ka-0.5*c*kbf+c*0.5*kbr)/N
    dCO=(-kbf+ka+kbr)*c/N
    dCO2=(kbf-kbr)*c/N
    dH2O=hid/2*ka/N
    return dC,dO2,dCO,dCO2,dH2O

def twoStepKinects (Concentrations0,ts,Temperature,Pressure):
    concentration = odeint(dc,Concentrations0,ts,args=(Temperature,))[-1]
    #print(concentration)
    #mass_burned=(m_c-(concentration[0]*8315*Temperature*M_c*mols/(Pressure*10**-3)))/m_c
    ro = Pressure * 10**-3 * M_m /(Ru * Temperature)
    dx = (-dc(concentration,ts[-1],Temperature)[0]*M_c *10**3/ ro)/Y0
    mass_burned = (Y0 - concentration[0] * M_c *10**3/ro)/Y0
    return mass_burned,concentration


ts = [radians(-164),radians(-164)+0.010821041362364843]

T = [371.206813049325, 369.7053362485424, 370.5415648880834,
       371.5128963750241, 372.6221935123777, 373.872875352755,
       375.2689283908682, 376.8149194332085, 378.51601007768716,
       380.3779727433393, 382.40720819831176, 384.6107645456003,
       386.99635763914154, 389.5723929151828, 392.3479886374012,
       395.3330005581685, 398.5380479936524, 401.974541286376,
       405.6547105769701, 409.5916357083282, 413.7992769292442,
       418.29250582048167, 423.08713550039766, 428.199948647155,
       433.6487211250646, 439.45223796627056, 445.63029701210985,
       452.20369354469454, 459.1941765127793, 466.6243632546127,
       474.5175945580847, 482.89770501862665, 491.78867431609257,
       501.2141124087597, 511.19651468498955, 521.7562005670602,
       532.9098195158724, 544.668270631975, 557.033835572683,
       569.9962710407126, 583.5275528170265, 597.5749241180356,
       612.0519092410354, 626.8270703244954, 641.7106127499599,
       656.4396346552334, 670.6640457670035, 683.9370578993097,
       695.7164769882303, 705.3849178632653, 712.2966161570611,
       715.8531889289385, 708.633784782243, 769.4806501646866,
       887.1775518690614, 1044.2279976978846, 1223.292740755434,
       1409.1710879774414, 1588.9034131874118, 1752.0292559429058,
       1891.0215264928431, 2001.5199938843107, 2082.183043376235,
       2134.1895070444084, 2061.765786914999, 1994.9025987973491,
       1933.151145373899, 1876.0679469512822, 1823.2334050680226,
       1774.2604561870667, 1728.797289831365, 1686.5267787910645,
       1647.1642740621114, 1610.4547316414962, 1576.169697791036,
       1544.104414199381, 1514.0751552073914, 1485.916831380777,
       1459.4808567446357, 1434.6332617361518, 1411.2530291727417,
       1389.2306302933055, 1368.4667393017025, 1348.8711065978491,
       1330.3615726013577, 1312.8632056702802, 1296.3075491083994,
       1280.6319636718404, 1265.7790533451912, 1251.696163458611,
       1238.3349414525123, 1225.6509517570255, 1213.6033373284845,
       1202.1545213704665, 1191.269943658433, 1180.91782668698,
       1171.068967568256, 1161.696552230846, 1152.7759890136183,
       1144.284759212366]
P = [  67490.        ,   66481.30237452,   67027.84030529,
         67672.14132163,   68418.83611804,   69273.39694462,
         70242.21280447,   71332.67886296,   72553.30203277,
         73913.82511269,   75425.37235035,   77100.6198881 ,
         78953.99525795,   81001.9109431 ,   83263.03805367,
         85758.62740952,   88512.88683292,   91553.4252862 ,
         94911.77671414,   98624.01914438,  102731.50786599,
        107281.74545223,  112329.41612964,  117937.61767788,
        124179.33074246,  131139.17328888,  138915.49684287,
        147622.89107462,  157395.17350989,  168388.95079416,
        180787.8447207 ,  194807.47645898,  210701.2894082 ,
        228767.25360184,  249355.41385489,  272876.0895998 ,
        299808.25769871,  330707.17608395,  366209.52249486,
        407033.0736127 ,  453966.02702542,  507838.27221696,
        569463.13110717,  639533.63508968,  718453.56756248,
        806083.6167713 ,  901393.6174215 , 1002043.18798418,
       1103975.20688393, 1201197.09504132, 1286006.19871769,
       1349898.94035083, 1371702.20485798, 1500327.47644186,
       1709007.86159871, 1950707.05759679, 2179157.73969381,
       2359840.51096663, 2473043.49928535, 2513079.43276812,
       2485224.61971247, 2401619.16823199, 2277323.63538623,
       2127298.01351526, 1874731.86646565, 1657675.67971328,
       1471468.09150843, 1311732.28418893, 1174543.29380166,
       1056479.04484577,  954608.10080457,  866446.80523115,
        789904.75768868,  723228.91104011,  664951.39704852,
        613843.23122867,  568874.44563348,  529180.38911493,
        494033.57307305,  462820.32190156,  435021.49277228,
        410196.59264681,  387970.70540138,  368023.72999629,
        350081.51273018,  333908.52909735,  319301.83270515,
        306086.04056907,  294109.16695576,  283239.15304077,
        273360.96823179,  264374.1822048 ,  256190.92548776,
        248734.17162943,  241936.28629285,  235737.79857444,
        230086.35792385,  224935.84659407,  220245.62288303,
        215979.87477065]
lista=[]
for te,p in zip(T,P):
    dx,conc = twoStepKinects(Concentrations0,ts,float(te),float(p))
    ts = [ts[-1],ts[-1]+0.010821041362364843]
    Concentrations0 = conc
    lista.append(dx)
    print(dx)
plt.plot(T,lista)